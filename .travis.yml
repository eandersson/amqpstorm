dist: focal
os: linux
language: python
addons:
  hosts:
    - rmq.eandersson.net
python:
  - 2.7
  - 3.6
  - 3.7
  - 3.8
  - 3.9
  - 3.10-dev
before_install:
  - docker build -t amqpstormdev ./docker/
  - docker run -d --hostname rmq.eandersson.net --name amqpstormdev -p 5671:5671 -p 5672:5672 -p 15671:15671 -p 15672:15672 amqpstormdev
  - docker cp amqpstormdev:/etc/rabbitmq/ssl/ ./amqpstorm/tests/resources/
  - docker exec amqpstormdev wait-for-rabbitmq
  - docker exec amqpstormdev rabbitmqctl add_user 'eandersson' '2a55f70a841f18b'
  - docker exec amqpstormdev rabbitmqctl -p / set_permissions 'eandersson' '.*' '.*' '.*'
  - docker exec amqpstormdev rabbitmqctl set_user_tags eandersson administrator
  - nc -zv rmq.eandersson.net 5671  || exit 1
  - nc -zv rmq.eandersson.net 5672  || exit 1
  - nc -zv rmq.eandersson.net 15671 || exit 1
  - nc -zv rmq.eandersson.net 15672 || exit 1
install:
  - pip install -r requirements.txt
  - pip install -r test-requirements.txt
script:
  - nosetests -v -l DEBUG --logging-level=DEBUG --with-coverage --cover-package=amqpstorm --with-timer --timer-top-n 10
  - flake8 --ignore=F821 .
after_success:
  - bash <(curl -s https://codecov.io/bash)
services:
  - docker
